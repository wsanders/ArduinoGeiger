#!/usr/bin/python3
import pigpio
import datetime
import sys
from astral import sun
from astral import LocationInfo


# LED Control with auto twilight dimming.
# Does not save state, just call again every 1/2 hour or so to update brightness
# This version doesn't trash builtin audio by nuking hardware PWM. Doesn't put an unreasonable load
# on pigpiod, 10% or so on ancient B rev 2.
# color to pins from a custom led board I built
# A tad slow because of the bulk of astral

colors = {
    "green" : 14,
    "red" : 15,
    "blue" : 18,
    "white" : 23
}
# actually use this a multiplier to turn led on off
onoff = { 'on' : 1.0, 'off' : 0.0 }


color = sys.argv[1]
ledstate = sys.argv[2]
pin = colors[color]
print (color, ledstate, pin)

pipins=pigpio.pi()
city = LocationInfo("me", "", "", 37.9, -122.1)
now = datetime.datetime.now(datetime.timezone.utc)
night = sun.night(city.observer)
day = sun.daylight(city.observer)

print (night)
print (day)


if ((now > day[0]) and (now < day[1])):
    print ("DAYLIGHT")
    pipins.set_PWM_dutycycle(pin, 255 * 1.0* onoff[ledstate])
if ((now > night[0]) and (now < night[1])):
    print ("NIGHT")
    pipins.set_PWM_dutycycle(pin, 255 * 0.2 * onoff[ledstate])
